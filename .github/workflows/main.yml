name: Build HWID Spoofer

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  SOLUTION_FILE: xyz.spoofer.final.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup Windows Driver Kit (WDK)
      run: |
        choco install windows-driver-kit -y
        
    - name: Add WDK to PATH
      shell: pwsh
      run: |
        $wdkPath = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64"
        echo $wdkPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE }}

    - name: Build Usermode Application
      run: |
        msbuild ${{ env.SOLUTION_FILE }} `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:Platform=${{ env.BUILD_PLATFORM }} `
          /t:xyz_spoofer_final `
          /m `
          /v:minimal

    - name: Build Kernel Driver
      run: |
        msbuild ${{ env.SOLUTION_FILE }} `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:Platform=${{ env.BUILD_PLATFORM }} `
          /p:TargetVersion=Windows10 `
          /p:SignMode=TestSign `
          /m `
          /v:minimal
      continue-on-error: true

    - name: List build outputs
      shell: pwsh
      run: |
        Write-Host "=== Build Artifacts ===" -ForegroundColor Cyan
        Get-ChildItem -Path . -Recurse -Include *.exe,*.sys,*.dll | Where-Object { $_.Directory -like "*${{ env.BUILD_CONFIGURATION }}*" }

    - name: Upload Usermode Binaries
      uses: actions/upload-artifact@v4
      with:
        name: usermode-binaries-${{ env.BUILD_PLATFORM }}
        path: |
          **/${{ env.BUILD_CONFIGURATION }}/**/*.exe
          **/${{ env.BUILD_CONFIGURATION }}/**/*.dll
        if-no-files-found: warn

    - name: Upload Kernel Driver
      uses: actions/upload-artifact@v4
      with:
        name: kernel-driver-${{ env.BUILD_PLATFORM }}
        path: |
          **/${{ env.BUILD_CONFIGURATION }}/**/*.sys
          **/${{ env.BUILD_CONFIGURATION }}/**/*.inf
          **/${{ env.BUILD_CONFIGURATION }}/**/*.cat
        if-no-files-found: warn

    - name: Upload PDB Files
      uses: actions/upload-artifact@v4
      with:
        name: debug-symbols-${{ env.BUILD_PLATFORM }}
        path: |
          **/${{ env.BUILD_CONFIGURATION }}/**/*.pdb
        if-no-files-found: warn

  build-additional-platforms:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [Win32, ARM64]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Build ${{ matrix.platform }}
      run: |
        msbuild ${{ env.SOLUTION_FILE }} `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /p:Platform=${{ matrix.platform }} `
          /m `
          /v:minimal
      continue-on-error: true

    - name: Upload ${{ matrix.platform }} Binaries
      uses: actions/upload-artifact@v4
      with:
        name: binaries-${{ matrix.platform }}
        path: |
          **/${{ env.BUILD_CONFIGURATION }}/**/*.exe
          **/${{ env.BUILD_CONFIGURATION }}/**/*.sys
          **/${{ env.BUILD_CONFIGURATION }}/**/*.dll
        if-no-files-found: warn
