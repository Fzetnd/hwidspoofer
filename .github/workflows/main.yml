name: Build HWID Spoofer

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  SOLUTION_FILE: xyz.spoofer.final.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install DirectX SDK (June 2010)
      shell: cmd
      run: |
        echo Downloading DirectX SDK...
        curl -L "https://download.microsoft.com/download/A/E/7/AE743F1F-632B-4809-87A9-AA1BB3458E31/DXSDK_Jun10.exe" -o "%TEMP%\DXSDK_Jun10.exe"
        echo Installing DirectX SDK (this takes 2-3 minutes)...
        "%TEMP%\DXSDK_Jun10.exe" /U
        echo DirectX SDK installation complete

    - name: Verify DirectX SDK
      shell: cmd
      run: |
        if exist "C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\Include\D3dx9tex.h" (
          echo SUCCESS: DirectX SDK installed correctly
          echo D3dx9tex.h found
        ) else (
          echo ERROR: DirectX SDK not found!
          exit /b 1
        )

    - name: Install Windows SDK
      shell: cmd
      run: choco install windows-sdk-10-version-2004-all -y

    - name: Download and Install WDK
      shell: cmd
      run: |
        echo Downloading WDK (this takes 5-10 minutes)...
        curl -L "https://go.microsoft.com/fwlink/?linkid=2249371" -o "%TEMP%\wdksetup.exe"
        echo Installing WDK...
        "%TEMP%\wdksetup.exe" /features + /quiet /norestart
        echo WDK installation complete

    - name: Restore NuGet packages
      shell: cmd
      run: nuget restore %SOLUTION_FILE%

    - name: Build Solution
      shell: cmd
      run: |
        set "DXSDK_DIR=C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\"
        echo Building with DirectX SDK at: %DXSDK_DIR%
        msbuild %SOLUTION_FILE% /p:Configuration=%BUILD_CONFIGURATION% /p:Platform=%BUILD_PLATFORM% /m /v:minimal /fl /flp:logfile=build.log;verbosity=detailed

    - name: Upload Build Log on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        if-no-files-found: ignore

    - name: List Build Output
      shell: cmd
      run: |
        echo === Build Output ===
        dir /s /b *.exe *.sys *.dll 2>nul | findstr /i "%BUILD_CONFIGURATION%"

    - name: Upload Usermode Binaries
      uses: actions/upload-artifact@v4
      with:
        name: usermode-binaries-x64
        path: |
          **/${{ env.BUILD_CONFIGURATION }}/**/*.exe
          **/${{ env.BUILD_CONFIGURATION }}/**/*.dll
        if-no-files-found: warn

    - name: Upload Kernel Driver
      uses: actions/upload-artifact@v4
      with:
        name: kernel-driver-x64
        path: |
          **/${{ env.BUILD_CONFIGURATION }}/**/*.sys
          **/${{ env.BUILD_CONFIGURATION }}/**/*.inf
          **/${{ env.BUILD_CONFIGURATION }}/**/*.cat
        if-no-files-found: warn

    - name: Upload Debug Symbols
      uses: actions/upload-artifact@v4
      with:
        name: debug-symbols-x64
        path: |
          **/${{ env.BUILD_CONFIGURATION }}/**/*.pdb
        if-no-files-found: warn
