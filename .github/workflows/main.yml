name: Build HWID Spoofer - All Configurations

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  SOLUTION_FILE: xyz.spoofer.final.sln
  BUILD_PLATFORM: x64

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install DirectX SDK (June 2010)
      shell: cmd
      run: |
        echo Downloading DirectX SDK...
        curl -L "https://download.microsoft.com/download/A/E/7/AE743F1F-632B-4809-87A9-AA1BB3458E31/DXSDK_Jun10.exe" -o "%TEMP%\DXSDK_Jun10.exe"
        echo Installing DirectX SDK (this takes 2-3 minutes)...
        "%TEMP%\DXSDK_Jun10.exe" /U
        echo DirectX SDK installation complete

    - name: Verify DirectX SDK
      shell: cmd
      run: |
        if exist "C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\Include\D3dx9tex.h" (
          echo SUCCESS: DirectX SDK installed correctly
        ) else (
          echo ERROR: DirectX SDK not found!
          exit /b 1
        )

    - name: Install Windows SDK
      shell: cmd
      run: choco install windows-sdk-10-version-2004-all -y

    - name: Download and Install WDK
      shell: cmd
      run: |
        echo Downloading WDK...
        curl -L "https://go.microsoft.com/fwlink/?linkid=2249371" -o "%TEMP%\wdksetup.exe"
        echo Installing WDK...
        "%TEMP%\wdksetup.exe" /features + /quiet /norestart
        echo WDK installation complete

    - name: Restore NuGet packages
      shell: cmd
      run: nuget restore %SOLUTION_FILE%

    - name: Inspect Solution Projects
      shell: pwsh
      run: |
        Write-Host "=== ANALYZING SOLUTION FILE ===" -ForegroundColor Cyan
        $solutionContent = Get-Content $env:SOLUTION_FILE -Raw
        
        # Extract all project entries
        $projectPattern = 'Project\("{[^}]+}"\)\s*=\s*"([^"]+)",\s*"([^"]+)"'
        $projects = [regex]::Matches($solutionContent, $projectPattern)
        
        Write-Host "`nFOUND $($projects.Count) PROJECTS:" -ForegroundColor Yellow
        foreach ($match in $projects) {
          $projectName = $match.Groups[1].Value
          $projectPath = $match.Groups[2].Value
          Write-Host "  - $projectName" -ForegroundColor Green
          Write-Host "    Path: $projectPath" -ForegroundColor Gray
        }
        
        # Check for .vcxproj files
        Write-Host "`n=== SCANNING FOR ALL .VCXPROJ FILES ===" -ForegroundColor Cyan
        Get-ChildItem -Path . -Filter "*.vcxproj" -Recurse | ForEach-Object {
          Write-Host "  Found: $($_.FullName)" -ForegroundColor Yellow
          
          # Check if it's an application or driver
          $content = Get-Content $_.FullName -Raw
          if ($content -match '<ConfigurationType>([^<]+)</ConfigurationType>') {
            $type = $matches[1]
            Write-Host "    Type: $type" -ForegroundColor Cyan
          }
        }

    - name: Build All Configurations
      shell: cmd
      run: |
        set "DXSDK_DIR=C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\"
        
        echo ========================================
        echo Building Debug x64 (THIS BUILDS THE .EXE!)
        echo ========================================
        msbuild %SOLUTION_FILE% /p:Configuration=Debug /p:Platform=%BUILD_PLATFORM% /t:Rebuild /m /v:normal
        
        echo ========================================
        echo Building Release x64 (THIS BUILDS THE .DLL)
        echo ========================================
        msbuild %SOLUTION_FILE% /p:Configuration=Release /p:Platform=%BUILD_PLATFORM% /t:Rebuild /m /v:normal
        
        echo ========================================
        echo SCANNING FOR OUTPUT FILES
        echo ========================================
        echo Debug output:
        dir /s /b Debug\*.exe Debug\*.dll 2>nul
        echo.
        echo Release output:
        dir /s /b Release\*.exe Release\*.dll 2>nul
        echo.
        echo x64 folders:
        dir /s /b x64\Debug\*.exe x64\Debug\*.dll 2>nul
        dir /s /b x64\Release\*.exe x64\Release\*.dll 2>nul

    - name: Deep Scan for ALL Compiled Files
      id: scan
      shell: pwsh
      run: |
        Write-Host "=== DEEP SCANNING FOR COMPILED FILES ===" -ForegroundColor Cyan
        
        # Find all compiled files (excluding source code)
        $compiledExtensions = @('*.exe', '*.dll', '*.sys', '*.inf', '*.cat', '*.pdb', '*.lib', '*.exp')
        $excludeDirs = @('.git', '.github', 'obj', 'packages', 'node_modules')
        
        $allFiles = @()
        foreach ($ext in $compiledExtensions) {
          $files = Get-ChildItem -Path . -Filter $ext -Recurse -ErrorAction SilentlyContinue | 
                   Where-Object { 
                     $exclude = $false
                     foreach ($dir in $excludeDirs) {
                       if ($_.FullName -like "*\$dir\*") { $exclude = $true; break }
                     }
                     -not $exclude
                   }
          $allFiles += $files
        }
        
        Write-Host "`nFOUND $($allFiles.Count) COMPILED FILES:" -ForegroundColor Green
        $allFiles | ForEach-Object { Write-Host "  - $($_.FullName)" }
        
        # Find .sys files specifically
        $sysFiles = $allFiles | Where-Object { $_.Extension -eq '.sys' }
        Write-Host "`nFOUND $($sysFiles.Count) KERNEL DRIVERS (.sys):" -ForegroundColor Yellow
        $sysFiles | ForEach-Object { Write-Host "  - $($_.FullName)" -ForegroundColor Yellow }
        
        # Find .exe files
        $exeFiles = $allFiles | Where-Object { $_.Extension -eq '.exe' }
        Write-Host "`nFOUND $($exeFiles.Count) EXECUTABLES (.exe):" -ForegroundColor Cyan
        $exeFiles | ForEach-Object { Write-Host "  - $($_.FullName)" -ForegroundColor Cyan }

    - name: Create Output Directory Structure
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "compiled_output"
        New-Item -ItemType Directory -Force -Path "compiled_output/Debug"
        New-Item -ItemType Directory -Force -Path "compiled_output/Release"
        New-Item -ItemType Directory -Force -Path "compiled_output/Drivers"
        New-Item -ItemType Directory -Force -Path "compiled_output/Executables"
        New-Item -ItemType Directory -Force -Path "compiled_output/Libraries"

    - name: Organize All Compiled Files
      shell: pwsh
      run: |
        $compiledExtensions = @('*.exe', '*.dll', '*.sys', '*.inf', '*.cat', '*.pdb', '*.lib')
        $excludeDirs = @('.git', '.github', 'obj', 'packages')
        
        foreach ($ext in $compiledExtensions) {
          Get-ChildItem -Path . -Filter $ext -Recurse -ErrorAction SilentlyContinue | 
            Where-Object { 
              $exclude = $false
              foreach ($dir in $excludeDirs) {
                if ($_.FullName -like "*\$dir\*") { $exclude = $true; break }
              }
              -not $exclude
            } | ForEach-Object {
              $file = $_
              $dest = "compiled_output"
              
              # Organize by type
              if ($file.Extension -eq '.sys' -or $file.Extension -eq '.inf' -or $file.Extension -eq '.cat') {
                $dest = "compiled_output/Drivers"
              } elseif ($file.Extension -eq '.exe') {
                $dest = "compiled_output/Executables"
              } elseif ($file.Extension -eq '.dll' -or $file.Extension -eq '.lib') {
                $dest = "compiled_output/Libraries"
              }
              
              # Also organize by configuration
              if ($file.FullName -like "*\Debug\*") {
                Copy-Item -Path $file.FullName -Destination "compiled_output/Debug" -Force
              } elseif ($file.FullName -like "*\Release\*") {
                Copy-Item -Path $file.FullName -Destination "compiled_output/Release" -Force
              }
              
              Copy-Item -Path $file.FullName -Destination $dest -Force
              Write-Host "Copied: $($file.Name) -> $dest"
            }
        }

    - name: Upload Complete Build Package
      uses: actions/upload-artifact@v4
      with:
        name: COMPLETE-BUILD-PACKAGE
        path: compiled_output/
        if-no-files-found: warn

    - name: Upload Debug Build
      uses: actions/upload-artifact@v4
      with:
        name: Debug-Build
        path: |
          **/Debug/**/*.exe
          **/Debug/**/*.dll
          **/Debug/**/*.sys
          **/Debug/**/*.pdb
        if-no-files-found: warn

    - name: Upload Release Build
      uses: actions/upload-artifact@v4
      with:
        name: Release-Build
        path: |
          **/Release/**/*.exe
          **/Release/**/*.dll
          **/Release/**/*.sys
          **/Release/**/*.pdb
        if-no-files-found: warn

    - name: Upload ALL Kernel Drivers (.sys)
      uses: actions/upload-artifact@v4
      with:
        name: ALL-KERNEL-DRIVERS
        path: |
          **/*.sys
          **/*.inf
          **/*.cat
          !.git/**
          !obj/**
        if-no-files-found: warn

    - name: Upload ALL Executables (.exe)
      uses: actions/upload-artifact@v4
      with:
        name: ALL-EXECUTABLES
        path: |
          **/*.exe
          !.git/**
          !obj/**
          !packages/**
        if-no-files-found: warn

    - name: Build Summary
      shell: pwsh
      run: |
        Write-Host "`n========================================" -ForegroundColor Green
        Write-Host "BUILD COMPLETE!" -ForegroundColor Green
        Write-Host "========================================" -ForegroundColor Green
        Write-Host "`n⚠️  IMPORTANT: Based on your project config:" -ForegroundColor Yellow
        Write-Host "   Debug x64   = Builds .EXE (Application)" -ForegroundColor Cyan
        Write-Host "   Release x64 = Builds .DLL (Library)" -ForegroundColor Cyan
        Write-Host "`nTo get the EXECUTABLE, download the Debug-Build artifact!" -ForegroundColor Yellow
        Write-Host "`nAll artifacts available in the Actions tab"
